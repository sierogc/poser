<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status Monitor</title>
    <style>
        /* VARIABILE: Dimensione di default per desktop */
        :root {
            --main-font-size: 3.5rem; 
            --data-value-width: 250px; 
        }

        /* Responsive per smartphone: Dimensione e garanzia riga singola */
        @media (max-width: 768px) {
            :root {
                --main-font-size: 0.9rem; 
                --data-value-width: 90px; 
            }
            .status-line {
                white-space: nowrap; 
            }
        }
        
        body, html {
            height: 100%;
            margin: 0;
            
            /* GESTIONE SFONDO */
            background-image: url('wallpaper.png'); 
            background-size: cover; 
            background-position: center; 
            background-attachment: fixed; 
            background-color: black; 
            
            /* GESTIONE TESTO */
            color: white; 
            font-family: Arial, sans-serif; 
            font-weight: 400; 
            
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;

            /* TRACCIA NERA INTORNO AL TESTO: NUOVO STILE AGGIUNTO */
            text-shadow: 2px 2px 2px black; /* Ombra per creare l'effetto traccia */
        }

        .status-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Stile di ogni singola riga (Prefisso + Valore) */
        .status-line {
            display: flex; 
            align-items: baseline;
            justify-content: center; 
            margin-bottom: 5px;
            font-size: var(--main-font-size);
            line-height: 1.1;
        }

        /* Prefisso (Il testo descrittivo) */
        .prefix {
            font-weight: 400; 
            margin-right: 20px;
        }

        /* Valore (I dati numerici: KM e Timer) */
        .value {
            width: var(--data-value-width); 
            min-width: var(--data-value-width); 
            
            font-weight: 700; 
            text-align: right; 
            color: white;
            font-feature-settings: "tnum"; 
        }

        .loading {
            color: #666; 
        }
    </style>
</head>
<body>

    <div class="status-container">
        
        <div class="status-line" id="distance-line">
            <span class="prefix">Ci separano </span>
            <span class="value" id="distance">... km</span>
        </div>
        
        <div class="status-line" id="timer-line">
            <span class="prefix">Abbiamo passato insieme: </span>
            <span class="value" id="timer">00:00:00</span>
        </div>
        
    </div>

    <script>
        // --- 1. LE TUE COORDINATE (Mariglianella, Via Roma 37) ---
        const MY_LAT = 40.9178; 
        const MY_LON = 14.4375; 

        // --- 2. GESTIONE TIMER PERSISTENTE ---
        const timerValueElement = document.getElementById('timer');
        let startTime = localStorage.getItem('firstConnectionTime');

        if (!startTime) {
            startTime = Date.now();
            localStorage.setItem('firstConnectionTime', startTime);
        } else {
            startTime = parseInt(startTime);
        }

        function updateTimer() {
            const diff = Date.now() - startTime; 
            const totalSeconds = Math.floor(diff / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const formattedTime = 
                (hours < 10 ? "0" + hours : hours) + ":" + 
                (minutes < 10 ? "0" + minutes : minutes) + ":" + 
                (seconds < 10 ? "0" + seconds : seconds);

            timerValueElement.textContent = formattedTime;
        }
        
        setInterval(updateTimer, 1000);
        updateTimer(); 

        // --- 3. LOGICA CALCOLO DISTANZA ---
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c; 
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }

        fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => {
                const distanceValueElement = document.getElementById('distance');
                if (data.latitude && data.longitude) {
                    const dist = calculateDistance(MY_LAT, MY_LON, data.latitude, data.longitude);
                    
                    document.getElementById('distance-line').className = "status-line";
                    
                    distanceValueElement.textContent = `${dist.toFixed(1)} km`;
                } else {
                    distanceValueElement.textContent = "XXX.X km";
                }
            })
            .catch(error => {
                console.error(error);
                document.getElementById('distance').textContent = "XXX.X km";
            });
    </script>
</body>
</html>
